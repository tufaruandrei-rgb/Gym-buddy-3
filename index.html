<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Gym Buddy</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 text-white min-h-screen">
    <div id="app"></div>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        const Horse = ({ className = "w-6 h-6" }) => (<svg className={className} fill="currentColor" viewBox="0 0 24 24"><path d="M20,8h-2.5c0-1.5-0.8-2.5-2-2.5S14,6.5,14,8h-1c-0.6,0-1,0.4-1,1v2c0,0.6,0.4,1,1,1h0.5L12,16H9l-1.5-3H6 c-0.6,0-1,0.4-1,1v5c0,0.6,0.4,1,1,1h1v1c0,0.6,0.4,1,1,1h1c0.6,0,1-0.4,1-1v-1h4v1c0,0.6,0.4,1,1,1h1c0.6,0,1-0.4,1-1v-1h1 c0.6,0,1-0.4,1-1v-5c0-0.6-0.4-1-1-1h-1.5L14,12h0.5c0.6,0,1-0.4,1-1V9c0-0.6-0.4-1-1-1h-0.5c0-0.5,0.2-1,0.5-1s0.5,0.5,0.5,1H20 c0.6,0,1-0.4,1-1S20.6,8,20,8z M16,6c0.3,0,0.5,0.2,0.5,0.5S16.3,7,16,7s-0.5-0.2-0.5-0.5S15.7,6,16,6z"/></svg>);
        const Plus = ({ className = "w-5 h-5" }) => (<svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" /></svg>);
        const Trash2 = ({ className = "w-5 h-5" }) => (<svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>);
        const TrendingUp = ({ className = "w-5 h-5" }) => (<svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" /></svg>);
        const Upload = ({ className = "w-4 h-4" }) => (<svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" /></svg>);
        const MessageCircle = ({ className = "w-5 h-5" }) => (<svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" /></svg>);
        const Send = ({ className = "w-5 h-5" }) => (<svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" /></svg>);

        const GymTracker = () => {
            const exercises = {'Spate': ['Lat pulldown', 'Cable row', 'Diag pulldown', 'Face pulls', 'Hyper extention'],'Piept': ['Bench', 'Bench plates', 'Chest incline press', 'Chest decline press', 'Chest flies', 'Chest downpush'],'Upper body': ['Shoulder press', 'Shoulder lat extension', 'Bar curl', 'Biceps curl', 'Preacher curl','Dips', 'Weight assist dips', 'Cable extension', 'Rope extension'],'Picioare': ['Squats', 'Leg extension', 'Leg Curls', 'Calf press']};
            const [workout, setWorkout] = useState({category: 'Spate',date: new Date().toISOString().split('T')[0],exercises: []});
            const [currentExercises, setCurrentExercises] = useState([{ name: exercises['Spate'][0], sets: [{ reps: '', weight: '' }] }]);
            const [savedWorkouts, setSavedWorkouts] = useState([]);
            const [showHistory, setShowHistory] = useState(false);
            const [showChat, setShowChat] = useState(false);
            const [sheetsUrl, setSheetsUrl] = useState('');
            const [geminiKey, setGeminiKey] = useState('');
            const [showUrlInput, setShowUrlInput] = useState(false);
            const [chatMessages, setChatMessages] = useState([]);
            const [userInput, setUserInput] = useState('');
            const [isAiThinking, setIsAiThinking] = useState(false);
            const chatEndRef = useRef(null);
            const SHEET_ID = '1FvV9MYZ8L4iYIcFpFdlwvR8S9E_f8CZivWgqiF8SIZw';

            useEffect(() => {
                const saved = localStorage.getItem('gymWorkouts');
                if (saved) setSavedWorkouts(JSON.parse(saved));
                const url = localStorage.getItem('sheetsUrl');
                if (url) setSheetsUrl(url);
                const key = localStorage.getItem('geminiKey');
                if (key) setGeminiKey(key);
            }, []);

            useEffect(() => {chatEndRef.current?.scrollIntoView({ behavior: 'smooth' });}, [chatMessages]);

            const addSet = (i) => {const n = [...currentExercises]; n[i].sets.push({ reps: '', weight: '' }); setCurrentExercises(n);};
            const updateSet = (i, j, f, v) => {const n = [...currentExercises]; n[i].sets[j][f] = v; setCurrentExercises(n);};
            const removeSet = (i, j) => {const n = [...currentExercises]; n[i].sets = n[i].sets.filter((_, x) => x !== j); setCurrentExercises(n);};
            const updateExerciseName = (i, name) => {const n = [...currentExercises]; n[i].name = name; setCurrentExercises(n);};
            const addExercise = () => {setCurrentExercises([...currentExercises, { name: exercises[workout.category][0], sets: [{ reps: '', weight: '' }] }]);};
            const removeExercise = (i) => {setCurrentExercises(currentExercises.filter((_, x) => x !== i));};

            const saveWorkout = () => {
                const validExercises = currentExercises.map(ex => ({...ex, sets: ex.sets.filter(s => s.reps && s.weight)})).filter(ex => ex.sets.length > 0);
                if (validExercises.length === 0) {alert('Please add at least one exercise with complete sets'); return;}
                const newWorkout = { ...workout, exercises: validExercises, savedAt: new Date().toISOString() };
                const newWorkouts = [...savedWorkouts, newWorkout];
                setSavedWorkouts(newWorkouts);
                localStorage.setItem('gymWorkouts', JSON.stringify(newWorkouts));
                setCurrentExercises([{ name: exercises[workout.category][0], sets: [{ reps: '', weight: '' }] }]);
                alert('Workout saved!');
            };

            const generateCSV = () => {
                let csv = '';
                savedWorkouts.forEach(w => {w.exercises.forEach(ex => {ex.sets.forEach((set, idx) => {csv += `${w.date}\t${ex.name}\t${idx + 1}\t${set.reps}\t${set.weight}\t${w.category}\n`;});});});
                return csv;
            };

            const copyCurrentWorkout = () => {
                let text = `Workout Date: ${workout.date}\nCategory: ${workout.category}\n\n`;
                currentExercises.forEach((ex, i) => {
                    const completedSets = ex.sets.filter(s => s.reps && s.weight);
                    if (completedSets.length > 0 || ex.sets.some(s => s.reps || s.weight)) {
                        text += `${ex.name}:\n`;
                        ex.sets.forEach((set, j) => {
                            if (set.reps || set.weight) {
                                text += `  Set ${j + 1}: ${set.reps || '?'} reps x ${set.weight || '?'}kg\n`;
                            }
                        });
                        text += '\n';
                    }
                });
                navigator.clipboard.writeText(text);
                alert('Current workout copied! Paste it in the conversation.');
            };

            const submitToSheets = async () => {
                if (!sheetsUrl) {setShowUrlInput(true); alert('Please set your Google Sheets Web App URL first'); return;}
                const csv = generateCSV();
                try {
                    const response = await fetch(sheetsUrl, {method: 'POST', headers: {'Content-Type': 'text/plain'}, body: csv, redirect: 'follow'});
                    if (response.ok || response.type === 'opaque') {alert('Data submitted to Google Sheets!'); setSavedWorkouts([]); localStorage.removeItem('gymWorkouts');} 
                    else {alert('Submission may have failed. Use Copy/Paste.');}
                } catch (error) {alert('Error: ' + error.message);}
            };

            const copyToClipboard = () => {const csv = generateCSV(); navigator.clipboard.writeText(csv); alert('Data copied!');};
            const saveSheetsUrl = () => {localStorage.setItem('sheetsUrl', sheetsUrl); setShowUrlInput(false); alert('Google Sheets URL saved!');};
            const saveGeminiKey = () => {localStorage.setItem('geminiKey', geminiKey); alert('Gemini API Key saved!');};
            const clearHistory = () => {if (confirm('Clear all saved workouts?')) {setSavedWorkouts([]); localStorage.removeItem('gymWorkouts');}};

            const fetchSheetData = async () => {
                try {
                    const response = await fetch(`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json`);
                    const text = await response.text();
                    const json = JSON.parse(text.substr(47).slice(0, -2));
                    return json.table.rows.slice(-50).map(row => ({date: row.c[0]?.f || row.c[0]?.v || '', exercise: row.c[1]?.v || '', set: row.c[2]?.v || '', reps: row.c[3]?.v || '', weight: row.c[4]?.v || '', category: row.c[5]?.v || ''})).filter(d => d.exercise);
                } catch (error) {return [];}
            };

            const askAI = async (message) => {
                if (!geminiKey) {alert('Please set your Gemini API Key in Setup first'); return;}
                if (!message.trim()) return;
                setChatMessages(prev => [...prev, { role: 'user', content: message }]);
                setUserInput('');
                setIsAiThinking(true);
                try {
                    const sheetData = await fetchSheetData();
                    const currentWorkoutContext = currentExercises.map(ex => `${ex.name}: ${ex.sets.filter(s => s.reps && s.weight).map((s, i) => `Set ${i+1}: ${s.reps} reps x ${s.weight}kg`).join(', ')}`).filter(e => e.includes('reps')).join('\n');
                    const prompt = `EÈ™ti un coach personal de salÄƒ inteligent. VorbeÈ™ti doar Ã®n romÃ¢nÄƒ, casual È™i prietenos.\n\nDate istorice (ultimele 50 intrÄƒri):\n${sheetData.slice(-30).map(d => `${d.date} - ${d.exercise}: Set ${d.set}, ${d.reps} reps, ${d.weight}kg`).join('\n')}\n\nAntrenamentul CURENT (Ã®n desfÄƒÈ™urare chiar acum):\nCategorie: ${workout.category}\nData: ${workout.date}\n${currentWorkoutContext || 'Niciun set completat Ã®ncÄƒ'}\n\nÃŽntrebarea: ${message}\n\nRÄƒspunde ca un coach experimentat care:\n- AnalizeazÄƒ progresul È™i dÄƒ sfaturi concrete bazate pe DATE\n- ComparÄƒ cu antrenamente similare anterioare\n- AvertizeazÄƒ despre creÈ™teri mari (>20%) sau volum excesiv\n- MotiveazÄƒ È™i Ã®ncurajeazÄƒ\n- MAX 3-4 propoziÈ›ii, direct la subiect\n- Ton casual, ca Ã®ntre prieteni\n\nIMPORTANT: DacÄƒ user Ã®ntreabÄƒ despre "acest" sau "ultimul" antrenament, te referi la datele din "Antrenamentul CURENT", NU la ultimele intrÄƒri din istoric!`;
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${geminiKey}`, {method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({contents: [{parts: [{ text: prompt }]}]})});
                    const data = await response.json();
                    const aiResponse = data.candidates?.[0]?.content?.parts?.[0]?.text || 'Scuze, nu am putut genera un rÄƒspuns.';
                    setChatMessages(prev => [...prev, { role: 'assistant', content: aiResponse }]);
                } catch (error) {setChatMessages(prev => [...prev, {role: 'assistant', content: 'Eroare la comunicare. VerificÄƒ API key-ul.'}]);}
                setIsAiThinking(false);
            };

            const totalVolume = currentExercises.reduce((sum, ex) => sum + ex.sets.reduce((s, set) => s + (parseInt(set.reps || 0) * parseFloat(set.weight || 0)), 0), 0);

            return (
                <div className="min-h-screen p-4">
                    <div className="max-w-2xl mx-auto">
                        <div className="bg-white/10 backdrop-blur-lg rounded-2xl p-6 mb-4 border border-white/20">
                            <div className="flex items-center justify-between mb-4">
                                <div className="flex items-center gap-3"><span className="text-3xl">ðŸ˜Š</span><h1 className="text-2xl font-bold">Gym Buddy</h1></div>
                                <div className="flex gap-2">
                                    <button onClick={copyCurrentWorkout} className="px-4 py-2 bg-green-600 rounded-lg hover:bg-green-700 transition flex items-center gap-2"><MessageCircle className="w-5 h-5" />Copy Workout</button>
                                    <a href="https://claude.ai/chat/01931657-4d88-7f23-b3da-c9efbfa0fec4" target="_blank" className="px-4 py-2 bg-blue-600 rounded-lg hover:bg-blue-700 transition flex items-center gap-2 no-underline text-white"><MessageCircle className="w-5 h-5" />Ask Claude</a>
                                    <button onClick={() => {setShowHistory(!showHistory); setShowChat(false);}} className="px-4 py-2 bg-purple-600 rounded-lg hover:bg-purple-700 transition">{showHistory ? 'Track' : 'History'}</button>
                                </div>
                            </div>
                            <div className="grid grid-cols-2 gap-4">
                                <div><label className="block text-sm text-purple-300 mb-2">Workout Type</label><select value={workout.category} onChange={(e) => {const cat = e.target.value; setWorkout({ ...workout, category: cat }); setCurrentExercises([{ name: exercises[cat][0], sets: [{ reps: '', weight: '' }] }]);}} className="w-full bg-white/20 border border-white/30 rounded-lg px-4 py-2 text-white">{Object.keys(exercises).map(cat => (<option key={cat} value={cat}>{cat}</option>))}</select></div>
                                <div><label className="block text-sm text-purple-300 mb-2">Date</label><input type="date" value={workout.date} onChange={(e) => setWorkout({ ...workout, date: e.target.value })} className="w-full bg-white/20 border border-white/30 rounded-lg px-4 py-2 text-white" /></div>
                            </div>
                            {totalVolume > 0 && (<div className="mt-4 flex items-center gap-2 text-purple-300"><TrendingUp className="w-5 h-5" /><span className="font-semibold">Total Volume: {totalVolume.toFixed(0)} kg</span></div>)}
                        </div>

                        {showChat ? (
                            <div className="bg-white/10 backdrop-blur-lg rounded-2xl p-6 border border-white/20">
                                <h2 className="text-xl font-bold mb-4 flex items-center gap-2"><MessageCircle className="w-6 h-6 text-blue-400" />AI Coach</h2>
                                {!geminiKey && (<div className="mb-4 p-4 bg-yellow-500/20 rounded-lg border border-yellow-500/30"><p className="text-sm mb-2">SeteazÄƒ Gemini API Key pentru AI Coach</p><input type="password" value={geminiKey} onChange={(e) => setGeminiKey(e.target.value)} placeholder="Paste API key aici" className="w-full bg-white/20 border border-white/30 rounded-lg px-4 py-2 text-white placeholder-white/50 mb-2" /><button onClick={saveGeminiKey} className="w-full py-2 bg-blue-600 hover:bg-blue-700 rounded-lg transition">Save API Key</button></div>)}
                                <div className="bg-white/5 rounded-lg p-4 h-96 overflow-y-auto mb-4">
                                    {chatMessages.length === 0 && (<div className="text-center text-white/50 py-8"><p className="mb-2">ðŸ‘‹ Salut! Sunt AI coach-ul tÄƒu.</p><p className="text-sm">ÃŽntreabÄƒ despre antrenament, progresie, sau cere sfaturi!</p></div>)}
                                    {chatMessages.map((msg, idx) => (<div key={idx} className={`mb-3 ${msg.role === 'user' ? 'text-right' : 'text-left'}`}><div className={`inline-block max-w-[80%] p-3 rounded-lg ${msg.role === 'user' ? 'bg-blue-600 text-white' : 'bg-white/20 text-white'}`}>{msg.content}</div></div>))}
                                    {isAiThinking && (<div className="text-left mb-3"><div className="inline-block bg-white/20 text-white p-3 rounded-lg"><span className="animate-pulse">Analyzing...</span></div></div>)}
                                    <div ref={chatEndRef} />
                                </div>
                                <div className="flex gap-2"><input type="text" value={userInput} onChange={(e) => setUserInput(e.target.value)} onKeyPress={(e) => e.key === 'Enter' && askAI(userInput)} placeholder="ÃŽntreabÄƒ ceva..." className="flex-1 bg-white/20 border border-white/30 rounded-lg px-4 py-3 text-white placeholder-white/50" disabled={isAiThinking} /><button onClick={() => askAI(userInput)} disabled={isAiThinking || !userInput.trim()} className="px-4 py-3 bg-blue-600 hover:bg-blue-700 rounded-lg transition disabled:opacity-50"><Send className="w-5 h-5" /></button></div>
                            </div>
                        ) : showHistory ? (
                            <div className="bg-white/10 backdrop-blur-lg rounded-2xl p-6 border border-white/20">
                                <div className="flex justify-between items-center mb-4 flex-wrap gap-2"><h2 className="text-xl font-bold">Saved ({savedWorkouts.length})</h2><div className="flex gap-2 flex-wrap"><button onClick={() => setShowUrlInput(!showUrlInput)} className="px-3 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg transition text-sm">Setup</button><button onClick={submitToSheets} className="px-3 py-2 bg-green-600 hover:bg-green-700 rounded-lg transition text-sm flex items-center gap-1"><Upload className="w-4 h-4" />Submit</button><button onClick={copyToClipboard} className="px-3 py-2 bg-purple-600 hover:bg-purple-700 rounded-lg transition text-sm">Copy</button><button onClick={clearHistory} className="px-3 py-2 bg-red-600 hover:bg-red-700 rounded-lg transition text-sm">Clear</button></div></div>
                                {showUrlInput && (<div className="mb-4 p-4 bg-white/5 rounded-lg space-y-3"><div><label className="block text-sm text-purple-300 mb-2">Google Sheets URL</label><input type="text" value={sheetsUrl} onChange={(e) => setSheetsUrl(e.target.value)} placeholder="https://script.google.com/..." className="w-full bg-white/20 border border-white/30 rounded-lg px-4 py-2 text-white placeholder-white/50" /><button onClick={saveSheetsUrl} className="w-full mt-2 py-2 bg-green-600 hover:bg-green-700 rounded-lg transition">Save</button></div><div><label className="block text-sm text-purple-300 mb-2">Gemini API Key</label><input type="password" value={geminiKey} onChange={(e) => setGeminiKey(e.target.value)} placeholder="API key" className="w-full bg-white/20 border border-white/30 rounded-lg px-4 py-2 text-white placeholder-white/50" /><button onClick={saveGeminiKey} className="w-full mt-2 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg transition">Save</button></div></div>)}
                                <div className="space-y-3 max-h-96 overflow-y-auto">{savedWorkouts.map((w, idx) => (<div key={idx} className="bg-white/5 rounded-lg p-4"><div className="flex justify-between items-center mb-2"><span className="font-semibold text-purple-300">{w.category}</span><span className="text-sm text-white/60">{w.date}</span></div><div className="text-sm text-white/70">{w.exercises.map(ex => ex.name).join(', ')}</div></div>))}</div>
                                {savedWorkouts.length === 0 && (<p className="text-center text-white/50 py-8">No saved workouts</p>)}
                            </div>
                        ) : (
                            <>
                                {currentExercises.map((exercise, exerciseIndex) => (
                                    <div key={exerciseIndex} className="bg-white/10 backdrop-blur-lg rounded-2xl p-6 mb-4 border border-white/20">
                                        <div className="flex justify-between items-center mb-4"><label className="block text-sm text-purple-300">Exercise {exerciseIndex + 1}</label>{currentExercises.length > 1 && (<button onClick={() => removeExercise(exerciseIndex)} className="text-red-400 hover:text-red-300"><Trash2 className="w-5 h-5" /></button>)}</div>
                                        <select value={exercise.name} onChange={(e) => updateExerciseName(exerciseIndex, e.target.value)} className="w-full mb-4 bg-white/20 border border-white/30 rounded-lg px-4 py-2 text-white">{exercises[workout.category].map(ex => (<option key={ex} value={ex}>{ex}</option>))}</select>
                                        <div className="space-y-3 mb-4">
                                            {exercise.sets.map((set, setIndex) => (
                                                <div key={setIndex} className="flex gap-2 items-center"><span className="text-purple-300 font-semibold w-8">{setIndex + 1}</span><select value={set.reps} onChange={(e) => updateSet(exerciseIndex, setIndex, 'reps', e.target.value)} className="flex-1 bg-white/20 border border-white/30 rounded-lg px-4 py-3 text-white"><option value="">Reps</option>{[...Array(40)].map((_, i) => (<option key={i + 1} value={i + 1}>{i + 1}</option>))}</select><input type="number" placeholder="Weight (kg)" value={set.weight} onChange={(e) => {const val = parseFloat(e.target.value); if (e.target.value === '' || val >= 0) {updateSet(exerciseIndex, setIndex, 'weight', e.target.value);}}} min="0" step="0.5" className="flex-1 bg-white/20 border border-white/30 rounded-lg px-4 py-3 text-white placeholder-white/50" />{exercise.sets.length > 1 && (<button onClick={() => removeSet(exerciseIndex, setIndex)} className="p-2 bg-red-500/20 hover:bg-red-500/30 rounded-lg transition"><Trash2 className="w-5 h-5" /></button>)}</div>
                                            ))}
                                        </div>
                                        <button onClick={() => addSet(exerciseIndex)} className="w-full py-3 bg-white/10 hover:bg-white/20 rounded-lg transition flex items-center justify-center gap-2 border border-white/30"><Plus className="w-5 h-5" />Add Set</button>
                                    </div>
                                ))}
                                <button onClick={addExercise} className="w-full mb-4 py-3 bg-purple-600 hover:bg-purple-700 rounded-lg transition font-semibold flex items-center justify-center gap-2"><Plus className="w-5 h-5" />Add Exercise</button>
                                <button onClick={saveWorkout} className="w-full py-4 bg-green-600 hover:bg-green-700 rounded-lg transition font-bold text-lg flex items-center justify-center gap-2"><Horse className="w-6 h-6" />Submit Workout</button>
                            </>
                        )}
                    </div>
                </div>
            );
        };
        ReactDOM.render(<GymTracker />, document.getElementById('app'));
    </script>
</body>
</html>
